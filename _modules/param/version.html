
<!DOCTYPE html>

<html>
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>param.version â€” param 1.11.1 documentation</title>
<link href="../../_static/css/theme.css" rel="stylesheet"/>
<link href="../../_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet"/>
<link href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css" rel="stylesheet"/>
<link as="font" crossorigin="" href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2" rel="preload" type="font/woff2"/>
<link as="font" crossorigin="" href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2" rel="preload" type="font/woff2"/>
<link href="../../_static/pygments.css" rel="stylesheet" type="text/css">
<link href="../../_static/basic.css" rel="stylesheet" type="text/css">
<link href="../../_static/togglebutton.css" rel="stylesheet" type="text/css">
<link href="../../_static/mystnb.css" rel="stylesheet" type="text/css"/>
<link href="../../_static/graphviz.css" rel="stylesheet" type="text/css"/>
<link href="../../_static/site.css" rel="stylesheet" type="text/css"/>
<link as="script" href="../../_static/js/index.1c5a1a01449ed65a7b51.js" rel="preload"/>
<script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
<script src="../../_static/jquery.js"></script>
<script src="../../_static/underscore.js"></script>
<script src="../../_static/doctools.js"></script>
<script src="../../_static/togglebutton.js"></script>
<script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
<link href="../../about.html" rel="author" title="About these documents">
<link href="../../genindex.html" rel="index" title="Index"/>
<link href="../../search.html" rel="search" title="Search"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<meta content="en" name="docsearch:language"/>
</link></link></link></link></head>
<body data-offset="80" data-spy="scroll" data-target="#bd-toc-nav">
<div class="container-fluid" id="banner"></div>
<nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">
<div id="navbar-start">
<a class="navbar-brand" href="../../index.html">
<img alt="logo" class="logo" src="../../_static/logo_horizontal.png"/>
</a>
</div>
<button aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler" data-target="#navbar-collapsible" data-toggle="collapse" type="button">
<span class="navbar-toggler-icon"></span>
</button>
<div class="col-lg-9 collapse navbar-collapse" id="navbar-collapsible">
<div class="mr-auto" id="navbar-center">
<div class="navbar-center-item">
<ul class="navbar-nav" id="navbar-main-elements">
<li class="toctree-l1 nav-item">
<a class="reference internal nav-link" href="../../index.html">
  Introduction
 </a>
</li>
<li class="toctree-l1 nav-item">
<a class="reference internal nav-link" href="../../getting_started.html">
  Getting Started
 </a>
</li>
<li class="toctree-l1 nav-item">
<a class="reference internal nav-link" href="../../user_guide/index.html">
  User Guide
 </a>
</li>
<li class="toctree-l1 nav-item">
<a class="reference internal nav-link" href="../../comparisons.html">
  Comparisons
 </a>
</li>
<li class="toctree-l1 nav-item">
<a class="reference internal nav-link" href="../../roadmap.html">
  Roadmap
 </a>
</li>
<li class="toctree-l1 nav-item">
<a class="reference internal nav-link" href="../../reference.html">
  API
 </a>
</li>
<li class="toctree-l1 nav-item">
<a class="reference external nav-link" href="https://github.com/holoviz/param">
  Github Source
 </a>
</li>
<li class="toctree-l1 nav-item">
<a class="reference internal nav-link" href="../../about.html">
  About
 </a>
</li>
</ul>
</div>
</div>
<div id="navbar-end">
<div class="navbar-end-item">
<ul aria-label="Icon Links" class="navbar-nav" id="navbar-icon-links">
<li class="nav-item">
<a class="nav-link" href="https://github.com/holoviz/param" rel="noopener" target="_blank" title="GitHub">
<span><i class="fab fa-github-square"></i></span>
<label class="sr-only">GitHub</label>
</a>
</li>
<li class="nav-item">
<a class="nav-link" href="https://discourse.holoviz.org/" rel="noopener" target="_blank" title="Discourse">
<span><i class="fab fa-discourse"></i></span>
<label class="sr-only">Discourse</label>
</a>
</li>
</ul>
</div>
</div>
</div>
</div>
</nav>
<div class="container-xl">
<div class="row">
<!-- Only show if we have sidebars configured, else just a small margin  -->
<div class="col-12 col-md-3 bd-sidebar"><form action="../../search.html" class="bd-search d-flex align-items-center" method="get">
<i class="icon fas fa-search"></i>
<input aria-label="Search the docs ..." autocomplete="off" class="form-control" id="search-input" name="q" placeholder="Search the docs ..." type="search"/>
</form><nav aria-label="Main navigation" class="bd-links" id="bd-docs-nav">
<div class="bd-toc-item active">
</div>
</nav>
</div>
<div class="d-none d-xl-block col-xl-2 bd-toc">
</div>
<main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
<div>
<h1>Source code for param.version</h1><div class="highlight"><pre>
<span></span><span class="sd">"""</span>
<span class="sd">Provide consistent and up-to-date ``__version__`` strings for</span>
<span class="sd">Python packages.</span>

<span class="sd">See https://github.com/holoviz/autover for more information.</span>
<span class="sd">"""</span>

<span class="c1"># The Version class is a copy of autover.version.Version v0.2.5,</span>
<span class="c1"># except as noted below.</span>
<span class="c1">#</span>
<span class="c1"># The current version of autover supports a workflow based on tagging</span>
<span class="c1"># a git repository, and reports PEP440 compliant version information.</span>
<span class="c1"># Previously, the workflow required editing of version numbers in</span>
<span class="c1"># source code, and the version was not necessarily PEP440 compliant.</span>
<span class="c1"># Version.__new__ is added here to provide the previous Version class</span>
<span class="c1"># (OldDeprecatedVersion) if Version is called in the old way.</span>


<span class="n">__author__</span> <span class="o">=</span> <span class="s1">'Jean-Luc Stevens'</span>

<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">subprocess</span><span class="o">,</span> <span class="nn">json</span>

<span class="k">def</span> <span class="nf">run_cmd</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                            <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                            <span class="n">cwd</span><span class="o">=</span><span class="n">cwd</span><span class="p">)</span>
    <span class="n">output</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">proc</span><span class="o">.</span><span class="n">communicate</span><span class="p">())</span>

    <span class="c1"># Detects errors as _either_ a non-zero return code _or_ messages</span>
    <span class="c1"># printed to stderr, because the return code is erroneously fixed at</span>
    <span class="c1"># zero in some cases (see https://github.com/holoviz/param/pull/389).</span>
    <span class="k">if</span> <span class="n">proc</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">proc</span><span class="o">.</span><span class="n">returncode</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output</span>



<div class="viewcode-block" id="Version"><a class="viewcode-back" href="../../reference.html#param.version.Version">[docs]</a><span class="k">class</span> <span class="nc">Version</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    A simple approach to Python package versioning that supports PyPI</span>
<span class="sd">    releases and additional information when working with version</span>
<span class="sd">    control. When obtaining a package from PyPI, the version returned</span>
<span class="sd">    is a string-formatted rendering of the supplied release tuple.</span>
<span class="sd">    For instance, release (1,0) tagged as ``v1.0`` in the version</span>
<span class="sd">    control system will return ``1.0`` for ``str(__version__)``.  Any</span>
<span class="sd">    number of items can be supplied in the release tuple, with either</span>
<span class="sd">    two or three numeric versioning levels typical.</span>

<span class="sd">    During development, a command like ``git describe`` will be used to</span>
<span class="sd">    compute the number of commits since the last version tag, the short</span>
<span class="sd">    commit hash, and whether the commit is dirty (has changes not yet</span>
<span class="sd">    committed). Version tags must start with a lowercase 'v' and have a</span>
<span class="sd">    period in them, e.g. v2.0, v0.9.8 or v0.1 and may include the PEP440</span>
<span class="sd">    prerelease identifiers of 'a' (alpha) 'b' (beta) or 'rc' (release</span>
<span class="sd">    candidate) allowing tags such as v2.0.a3, v0.9.8.b3 or v0.1.rc5.</span>

<span class="sd">    Also note that when version control system (VCS) information is</span>
<span class="sd">    used, the number of commits since the last version tag is</span>
<span class="sd">    determined. This approach is often useful in practice to decide</span>
<span class="sd">    which version is newer for a single developer, but will not</span>
<span class="sd">    necessarily be reliable when comparing against a different fork or</span>
<span class="sd">    branch in a distributed VCS.</span>

<span class="sd">    For git, if you want version control information available even in</span>
<span class="sd">    an exported archive (e.g. a .zip file from GitHub), you can set</span>
<span class="sd">    the following line in the .gitattributes file of your project::</span>

<span class="sd">      __init__.py export-subst</span>

<span class="sd">    Note that to support pip installation directly from GitHub via git</span>
<span class="sd">    archive, a .version file must be tracked by the repo to supply the</span>
<span class="sd">    release number (otherwise only the short SHA is available).</span>

<span class="sd">    The PEP440 format returned is [N!]N(.N)*[{a|b|rc}N][.postN+SHA]</span>
<span class="sd">    where everything before .postN is obtained from the tag, the N in</span>
<span class="sd">    .postN is the number of commits since the last tag and the SHA is</span>
<span class="sd">    obtained via git describe. This later portion is only shown if the</span>
<span class="sd">    commit count since the last tag is non zero. Instead of '.post', an</span>
<span class="sd">    alternate valid prefix such as '.rev', '_rev', '_r' or '.r' may be</span>
<span class="sd">    supplied."""</span>

    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="c1"># If called in the old way, provide the previous class. Means</span>
        <span class="c1"># PEP440/tag based workflow warning below will never appear.</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">'release'</span> <span class="ow">in</span> <span class="n">kw</span> <span class="ow">and</span> <span class="n">kw</span><span class="p">[</span><span class="s1">'release'</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> \
           <span class="p">(</span><span class="s1">'dev'</span> <span class="ow">in</span> <span class="n">kw</span> <span class="ow">and</span> <span class="n">kw</span><span class="p">[</span><span class="s1">'dev'</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> \
           <span class="p">(</span><span class="s1">'commit_count'</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">OldDeprecatedVersion</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Version</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>


    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">release</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fpath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">commit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reponame</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">commit_count_prefix</span><span class="o">=</span><span class="s1">'.post'</span><span class="p">,</span> <span class="n">archive_commit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        :release:      Release tuple (corresponding to the current VCS tag)</span>
<span class="sd">        :commit        Short SHA. Set to '$Format:%h$' for git archive support.</span>
<span class="sd">        :fpath:        Set to ``__file__`` to access version control information</span>
<span class="sd">        :reponame:     Used to verify VCS repository name.</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fpath</span> <span class="o">=</span> <span class="n">fpath</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_expected_commit</span> <span class="o">=</span> <span class="n">commit</span>

        <span class="k">if</span> <span class="n">release</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="s1">'commit_count'</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">'WARNING: param.Version now supports PEP440 and a new tag based workflow. See param/version.py for more details'</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">expected_release</span> <span class="o">=</span> <span class="n">release</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_commit</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="p">(</span><span class="n">commit</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">commit</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"$Format"</span><span class="p">))</span> <span class="k">else</span> <span class="n">commit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_commit_count</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_release</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prerelease</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">archive_commit</span><span class="o">=</span> <span class="n">archive_commit</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reponame</span> <span class="o">=</span> <span class="n">reponame</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commit_count_prefix</span> <span class="o">=</span> <span class="n">commit_count_prefix</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">prerelease</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Either None or one of 'aN' (alpha), 'bN' (beta) or 'rcN'</span>
<span class="sd">        (release candidate) where N is an integer.</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch</span><span class="p">()</span><span class="o">.</span><span class="n">_prerelease</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">release</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">"Return the release tuple"</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch</span><span class="p">()</span><span class="o">.</span><span class="n">_release</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">commit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">"A specification for this particular VCS version, e.g. a short git SHA"</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch</span><span class="p">()</span><span class="o">.</span><span class="n">_commit</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">commit_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">"Return the number of commits since the last release"</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch</span><span class="p">()</span><span class="o">.</span><span class="n">_commit_count</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dirty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">"True if there are uncommited changes, False otherwise"</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch</span><span class="p">()</span><span class="o">.</span><span class="n">_dirty</span>


<div class="viewcode-block" id="Version.fetch"><a class="viewcode-back" href="../../reference.html#param.version.Version.fetch">[docs]</a>    <span class="k">def</span> <span class="nf">fetch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Returns a tuple of the major version together with the</span>
<span class="sd">        appropriate SHA and dirty bit (for development version only).</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_release</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_release</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_release</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fpath</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_commit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expected_commit</span>
            <span class="k">return</span> <span class="bp">self</span>

         <span class="c1"># Only git right now but easily extended to SVN, Mercurial, etc.</span>
        <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'git'</span><span class="p">,</span> <span class="s1">'git.cmd'</span><span class="p">,</span> <span class="s1">'git.exe'</span><span class="p">]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">git_fetch</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">except</span> <span class="ne">EnvironmentError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">return</span> <span class="bp">self</span></div>


    <span class="k">def</span> <span class="nf">git_fetch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="o">=</span><span class="s1">'git'</span><span class="p">,</span> <span class="n">as_string</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">commit_argument</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_commit</span>
        <span class="n">output</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reponame</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Verify this is the correct repository (since fpath could</span>
                <span class="c1"># be an unrelated git repository, and autover could just have</span>
                <span class="c1"># been copied/installed into it).</span>
                <span class="n">remotes</span> <span class="o">=</span> <span class="n">run_cmd</span><span class="p">([</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'remote'</span><span class="p">,</span> <span class="s1">'-v'</span><span class="p">],</span>
                                  <span class="n">cwd</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fpath</span><span class="p">))</span>
                <span class="n">repo_matches</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'/'</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">reponame</span> <span class="o">+</span> <span class="s1">'.git'</span> <span class="p">,</span>
                                <span class="c1"># A remote 'server:reponame.git' can also be referred</span>
                                <span class="c1"># to (i.e. cloned) as `server:reponame`.</span>
                                <span class="s1">'/'</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">reponame</span> <span class="o">+</span> <span class="s1">' '</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">m</span> <span class="ow">in</span> <span class="n">remotes</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">repo_matches</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_from_file</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_update_from_vcs</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>
            <span class="k">if</span> <span class="n">output</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">output</span> <span class="o">=</span> <span class="n">run_cmd</span><span class="p">([</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'describe'</span><span class="p">,</span> <span class="s1">'--long'</span><span class="p">,</span> <span class="s1">'--match'</span><span class="p">,</span>
                                  <span class="s2">"v[0-9]*.[0-9]*.[0-9]*"</span><span class="p">,</span> <span class="s1">'--dirty'</span><span class="p">],</span>
                                 <span class="n">cwd</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fpath</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">as_string</span><span class="p">:</span> <span class="k">return</span> <span class="n">output</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e1</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_from_file</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_update_from_vcs</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_known_stale</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_commit_count</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">as_string</span><span class="p">:</span> <span class="k">return</span> <span class="n">output</span>

                <span class="c1"># If an explicit commit was supplied (e.g from git</span>
                <span class="c1"># archive), it should take precedence over the file.</span>
                <span class="k">if</span> <span class="n">commit_argument</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_commit</span> <span class="o">=</span> <span class="n">commit_argument</span>
                <span class="k">return</span>

            <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">e1</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'fatal: No names found, cannot describe anything.'</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">"Cannot find any git version tags of format v*.*"</span><span class="p">)</span>
                <span class="c1"># If there is any other error, return (release value still useful)</span>
                <span class="k">return</span> <span class="bp">self</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_update_from_vcs</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_known_stale</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        The commit is known to be from a file (and therefore stale) if a</span>
<span class="sd">        SHA is supplied by git archive and doesn't match the parsed commit.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_from_file</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">commit</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">commit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commit</span>

        <span class="n">known_stale</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">archive_commit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                       <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">archive_commit</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">'$Format'</span><span class="p">)</span>
                       <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">archive_commit</span> <span class="o">!=</span> <span class="n">commit</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">known_stale</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_commit_count</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">known_stale</span>

    <span class="k">def</span> <span class="nf">_output_from_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entry</span><span class="o">=</span><span class="s1">'git_describe'</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Read the version from a .version file that may exist alongside __init__.py.</span>

<span class="sd">        This file can be generated by piping the following output to file:</span>

<span class="sd">        git describe --long --match v*.*</span>
<span class="sd">        """</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">vfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fpath</span><span class="p">),</span> <span class="s1">'.version'</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">vfile</span><span class="p">,</span> <span class="s1">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span> <span class="c1"># File may be missing if using pip + git archive</span>
            <span class="k">return</span> <span class="kc">None</span>


    <span class="k">def</span> <span class="nf">_update_from_vcs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">):</span>
        <span class="s2">"Update state based on the VCS state e.g the output of git describe"</span>
        <span class="n">split</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'-'</span><span class="p">)</span>
        <span class="n">dot_split</span> <span class="o">=</span> <span class="n">split</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'.'</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'a'</span><span class="p">,</span><span class="s1">'b'</span><span class="p">,</span><span class="s1">'rc'</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="n">dot_split</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">prefix_split</span> <span class="o">=</span> <span class="n">dot_split</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_prerelease</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">prefix_split</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">dot_split</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">prefix_split</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">_release</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">el</span><span class="p">)</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">dot_split</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_commit_count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">split</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_commit</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">split</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span> <span class="c1"># Strip out 'g' prefix ('g'=&gt;'git')</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span> <span class="o">=</span> <span class="p">(</span><span class="n">split</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">'dirty'</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Version in x.y.z string format. Does not include the "v"</span>
<span class="sd">        prefix of the VCS version tags, for pip compatibility.</span>

<span class="sd">        If the commit count is non-zero or the repository is dirty,</span>
<span class="sd">        the string representation is equivalent to the output of::</span>

<span class="sd">          git describe --long --match v*.* --dirty</span>

<span class="sd">        (with "v" prefix removed).</span>
<span class="sd">        """</span>
        <span class="n">known_stale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_known_stale</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">release</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">known_stale</span><span class="p">:</span>
            <span class="n">extracted_directory_tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_from_file</span><span class="p">(</span><span class="n">entry</span><span class="o">=</span><span class="s1">'extracted_directory_tag'</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">'None'</span> <span class="k">if</span> <span class="n">extracted_directory_tag</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">extracted_directory_tag</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">release</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">known_stale</span><span class="p">:</span>
            <span class="n">extracted_directory_tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_from_file</span><span class="p">(</span><span class="n">entry</span><span class="o">=</span><span class="s1">'extracted_directory_tag'</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">extracted_directory_tag</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">extracted_directory_tag</span>
            <span class="k">return</span> <span class="s1">'0.0.0+g</span><span class="si">{SHA}</span><span class="s1">-gitarchive'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">SHA</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">archive_commit</span><span class="p">)</span>

        <span class="n">release</span> <span class="o">=</span> <span class="s1">'.'</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">el</span><span class="p">)</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="p">)</span>
        <span class="n">prerelease</span> <span class="o">=</span> <span class="s1">''</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prerelease</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">prerelease</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">commit_count</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dirty</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">release</span> <span class="o">+</span> <span class="n">prerelease</span>

        <span class="n">commit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commit</span>
        <span class="n">dirty</span> <span class="o">=</span> <span class="s1">'-dirty'</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dirty</span> <span class="k">else</span> <span class="s1">''</span>
        <span class="n">archive_commit</span> <span class="o">=</span> <span class="s1">''</span>
        <span class="k">if</span> <span class="n">known_stale</span><span class="p">:</span>
            <span class="n">archive_commit</span> <span class="o">=</span> <span class="s1">'-gitarchive'</span>
            <span class="n">commit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">archive_commit</span>

        <span class="k">if</span> <span class="n">archive_commit</span> <span class="o">!=</span> <span class="s1">''</span><span class="p">:</span>
            <span class="n">postcount</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commit_count_prefix</span> <span class="o">+</span> <span class="s1">'0'</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">commit_count</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
            <span class="n">postcount</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commit_count_prefix</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">commit_count</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">postcount</span> <span class="o">=</span> <span class="s1">''</span>

        <span class="n">components</span> <span class="o">=</span> <span class="p">[</span><span class="n">release</span><span class="p">,</span> <span class="n">prerelease</span><span class="p">,</span> <span class="n">postcount</span><span class="p">,</span>
                      <span class="s1">''</span> <span class="k">if</span> <span class="n">commit</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">'+g'</span> <span class="o">+</span> <span class="n">commit</span><span class="p">,</span> <span class="n">dirty</span><span class="p">,</span>
                      <span class="n">archive_commit</span><span class="p">]</span>
        <span class="k">return</span> <span class="s1">''</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">components</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="Version.abbrev"><a class="viewcode-back" href="../../reference.html#param.version.Version.abbrev">[docs]</a>    <span class="k">def</span> <span class="nf">abbrev</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Abbreviated string representation of just the release number.</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="s1">'.'</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">el</span><span class="p">)</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="p">)</span></div>

<div class="viewcode-block" id="Version.verify"><a class="viewcode-back" href="../../reference.html#param.version.Version.verify">[docs]</a>    <span class="k">def</span> <span class="nf">verify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string_version</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Check that the version information is consistent with the VCS</span>
<span class="sd">        before doing a release. If supplied with a string version,</span>
<span class="sd">        this is also checked against the current version. Should be</span>
<span class="sd">        called from setup.py with the declared package version before</span>
<span class="sd">        releasing to PyPI.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="n">string_version</span> <span class="ow">and</span> <span class="n">string_version</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">"Supplied string version does not match current version."</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dirty</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">"Current working directory is dirty."</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_release</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">release</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_release</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">"Declared release does not match current release tag."</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">commit_count</span> <span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">"Please update the VCS version tag before release."</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_expected_commit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expected_commit</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span> <span class="s2">"$Format"</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">"Declared release does not match the VCS version tag"</span><span class="p">)</span></div>



<div class="viewcode-block" id="Version.get_setup_version"><a class="viewcode-back" href="../../reference.html#param.version.Version.get_setup_version">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_setup_version</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">setup_path</span><span class="p">,</span> <span class="n">reponame</span><span class="p">,</span> <span class="n">describe</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">dirty</span><span class="o">=</span><span class="s1">'report'</span><span class="p">,</span> <span class="n">pkgname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">archive_commit</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Helper for use in setup.py to get the version from the .version file (if available)</span>
<span class="sd">        or more up-to-date information from git describe (if available).</span>

<span class="sd">        Assumes the __init__.py will be found in the directory</span>
<span class="sd">        {reponame}/__init__.py relative to setup.py unless pkgname is</span>
<span class="sd">        explicitly specified in which case that name is used instead.</span>

<span class="sd">        If describe is True, the raw string obtained from git described is</span>
<span class="sd">        returned which is useful for updating the .version file.</span>

<span class="sd">        The dirty policy can be one of 'report', 'strip', 'raise'. If it is</span>
<span class="sd">        'report' the version string may end in '-dirty' if the repository is</span>
<span class="sd">        in a dirty state.  If the policy is 'strip', the '-dirty' suffix</span>
<span class="sd">        will be stripped out if present. If the policy is 'raise', an</span>
<span class="sd">        exception is raised if the repository is in a dirty state. This can</span>
<span class="sd">        be useful if you want to make sure packages are not built from a</span>
<span class="sd">        dirty repository state.</span>
<span class="sd">        """</span>
        <span class="n">pkgname</span> <span class="o">=</span> <span class="n">reponame</span> <span class="k">if</span> <span class="n">pkgname</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">pkgname</span>
        <span class="n">policies</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'raise'</span><span class="p">,</span><span class="s1">'report'</span><span class="p">,</span> <span class="s1">'strip'</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">dirty</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">policies</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">"get_setup_version dirty policy must be in </span><span class="si">%r</span><span class="s2">"</span> <span class="o">%</span> <span class="n">policies</span><span class="p">)</span>

        <span class="n">fpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">setup_path</span><span class="p">,</span> <span class="n">pkgname</span><span class="p">,</span> <span class="s2">"__init__.py"</span><span class="p">)</span>
        <span class="n">version</span> <span class="o">=</span> <span class="n">Version</span><span class="p">(</span><span class="n">fpath</span><span class="o">=</span><span class="n">fpath</span><span class="p">,</span> <span class="n">reponame</span><span class="o">=</span><span class="n">reponame</span><span class="p">,</span> <span class="n">archive_commit</span><span class="o">=</span><span class="n">archive_commit</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">describe</span><span class="p">:</span>
            <span class="n">vstring</span> <span class="o">=</span> <span class="n">version</span><span class="o">.</span><span class="n">git_fetch</span><span class="p">(</span><span class="n">as_string</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vstring</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">version</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">version</span><span class="o">.</span><span class="n">dirty</span> <span class="ow">and</span> <span class="n">dirty</span> <span class="o">==</span> <span class="s1">'raise'</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s1">'Repository is in a dirty state.'</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">version</span><span class="o">.</span><span class="n">dirty</span> <span class="ow">and</span> <span class="n">dirty</span><span class="o">==</span><span class="s1">'strip'</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">vstring</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'-dirty'</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">vstring</span></div>


    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">extract_directory_tag</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">setup_path</span><span class="p">,</span> <span class="n">reponame</span><span class="p">):</span>
        <span class="n">setup_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">setup_path</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># Directory containing setup.py</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">reponame</span> <span class="o">+</span> <span class="s1">'-'</span> <span class="c1"># Prefix to match</span>
        <span class="k">if</span> <span class="n">setup_dir</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="n">setup_dir</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">):]</span>
            <span class="c1"># Assuming the tag is a version if it isn't empty, 'master' and has a dot in it</span>
            <span class="k">if</span> <span class="n">tag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">''</span><span class="p">,</span> <span class="s1">'master'</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">'.'</span> <span class="ow">in</span> <span class="n">tag</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">tag</span>
        <span class="k">return</span> <span class="kc">None</span>


    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">setup_version</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">setup_path</span><span class="p">,</span> <span class="n">reponame</span><span class="p">,</span> <span class="n">archive_commit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">pkgname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dirty</span><span class="o">=</span><span class="s1">'report'</span><span class="p">):</span>
        <span class="n">info</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">git_describe</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">pkgname</span> <span class="o">=</span> <span class="n">reponame</span> <span class="k">if</span> <span class="n">pkgname</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">pkgname</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Will only work if in a git repo and git is available</span>
            <span class="n">git_describe</span>  <span class="o">=</span> <span class="n">Version</span><span class="o">.</span><span class="n">get_setup_version</span><span class="p">(</span><span class="n">setup_path</span><span class="p">,</span>
                                                      <span class="n">reponame</span><span class="p">,</span>
                                                      <span class="n">describe</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                      <span class="n">dirty</span><span class="o">=</span><span class="n">dirty</span><span class="p">,</span>
                                                      <span class="n">pkgname</span><span class="o">=</span><span class="n">pkgname</span><span class="p">,</span>
                                                      <span class="n">archive_commit</span><span class="o">=</span><span class="n">archive_commit</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">git_describe</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">info</span><span class="p">[</span><span class="s1">'git_describe'</span><span class="p">]</span> <span class="o">=</span> <span class="n">git_describe</span>
        <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>

        <span class="k">if</span> <span class="n">git_describe</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">extracted_directory_tag</span> <span class="o">=</span> <span class="n">Version</span><span class="o">.</span><span class="n">extract_directory_tag</span><span class="p">(</span><span class="n">setup_path</span><span class="p">,</span> <span class="n">reponame</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">extracted_directory_tag</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">info</span><span class="p">[</span><span class="s1">'extracted_directory_tag'</span><span class="p">]</span> <span class="o">=</span> <span class="n">extracted_directory_tag</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">setup_path</span><span class="p">,</span> <span class="n">pkgname</span><span class="p">,</span> <span class="s1">'.version'</span><span class="p">),</span> <span class="s1">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s1">'extracted_directory_tag'</span><span class="p">:</span><span class="n">extracted_directory_tag</span><span class="p">}))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">'Error in setup_version: could not write .version file.'</span><span class="p">)</span>


        <span class="n">info</span><span class="p">[</span><span class="s1">'version_string'</span><span class="p">]</span> <span class="o">=</span>  <span class="n">Version</span><span class="o">.</span><span class="n">get_setup_version</span><span class="p">(</span><span class="n">setup_path</span><span class="p">,</span>
                                                            <span class="n">reponame</span><span class="p">,</span>
                                                            <span class="n">describe</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                            <span class="n">dirty</span><span class="o">=</span><span class="n">dirty</span><span class="p">,</span>
                                                            <span class="n">pkgname</span><span class="o">=</span><span class="n">pkgname</span><span class="p">,</span>
                                                            <span class="n">archive_commit</span><span class="o">=</span><span class="n">archive_commit</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">setup_path</span><span class="p">,</span> <span class="n">pkgname</span><span class="p">,</span> <span class="s1">'.version'</span><span class="p">),</span> <span class="s1">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">info</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">'Error in setup_version: could not write .version file.'</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">info</span><span class="p">[</span><span class="s1">'version_string'</span><span class="p">]</span></div>



<div class="viewcode-block" id="get_setup_version"><a class="viewcode-back" href="../../reference.html#param.version.get_setup_version">[docs]</a><span class="k">def</span> <span class="nf">get_setup_version</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">reponame</span><span class="p">,</span> <span class="n">pkgname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">archive_commit</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">"""Helper for use in setup.py to get the current version from either</span>
<span class="sd">    git describe or the .version file (if available).</span>

<span class="sd">    Set pkgname to the package name if it is different from the</span>
<span class="sd">    repository name.</span>

<span class="sd">    To ensure git information is included in a git archive, add</span>
<span class="sd">    setup.py to .gitattributes (in addition to __init__):</span>
<span class="sd">    ```</span>
<span class="sd">    __init__.py export-subst</span>
<span class="sd">    setup.py export-subst</span>
<span class="sd">    ```</span>
<span class="sd">    Then supply "$Format:%h$" for archive_commit.</span>

<span class="sd">    """</span>
    <span class="kn">import</span> <span class="nn">warnings</span>
    <span class="n">pkgname</span> <span class="o">=</span> <span class="n">reponame</span> <span class="k">if</span> <span class="n">pkgname</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">pkgname</span>
    <span class="k">if</span> <span class="n">archive_commit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">"No archive commit available; git archives will not contain version information"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Version</span><span class="o">.</span><span class="n">setup_version</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">location</span><span class="p">)),</span><span class="n">reponame</span><span class="p">,</span><span class="n">pkgname</span><span class="o">=</span><span class="n">pkgname</span><span class="p">,</span><span class="n">archive_commit</span><span class="o">=</span><span class="n">archive_commit</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_setupcfg_version"><a class="viewcode-back" href="../../reference.html#param.version.get_setupcfg_version">[docs]</a><span class="k">def</span> <span class="nf">get_setupcfg_version</span><span class="p">():</span>
    <span class="sd">"""As get_setup_version(), but configure via setup.cfg.</span>

<span class="sd">    If your project uses setup.cfg to configure setuptools, and hence has</span>
<span class="sd">    at least a "name" key in the [metadata] section, you can</span>
<span class="sd">    set the version as follows:</span>
<span class="sd">    ```</span>
<span class="sd">    [metadata]</span>
<span class="sd">    name = mypackage</span>
<span class="sd">    version = attr: autover.version.get_setup_version2</span>
<span class="sd">    ```</span>

<span class="sd">    If the repository name is different from the package name, specify</span>
<span class="sd">    `reponame` as a [tool:autover] option:</span>
<span class="sd">    ```</span>
<span class="sd">    [tool:autover]</span>
<span class="sd">    reponame = mypackage</span>
<span class="sd">    ```</span>

<span class="sd">    To ensure git information is included in a git archive, add</span>
<span class="sd">    setup.cfg to .gitattributes (in addition to __init__):</span>
<span class="sd">    ```</span>
<span class="sd">    __init__.py export-subst</span>
<span class="sd">    setup.cfg export-subst</span>
<span class="sd">    ```</span>

<span class="sd">    Then add the following to setup.cfg:</span>
<span class="sd">    ```</span>
<span class="sd">    [tool:autover.configparser_workaround.archive_commit=$Format:%h$]</span>
<span class="sd">    ```</span>

<span class="sd">    The above being a section heading rather than just a key is</span>
<span class="sd">    because setuptools requires % to be escaped with %, or it can't</span>
<span class="sd">    parse setup.cfg...but then git export-subst would not work.</span>

<span class="sd">    """</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">configparser</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">ConfigParser</span> <span class="k">as</span> <span class="nn">configparser</span> <span class="c1"># python2 (also prevents dict-like access)</span>
    <span class="kn">import</span> <span class="nn">re</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="s2">"setup.cfg"</span>
    <span class="n">autover_section</span> <span class="o">=</span> <span class="s1">'tool:autover'</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>
    <span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
    <span class="n">pkgname</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'metadata'</span><span class="p">,</span><span class="s1">'name'</span><span class="p">)</span>
    <span class="n">reponame</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">autover_section</span><span class="p">,</span><span class="s1">'reponame'</span><span class="p">,</span><span class="nb">vars</span><span class="o">=</span><span class="p">{</span><span class="s1">'reponame'</span><span class="p">:</span><span class="n">pkgname</span><span class="p">})</span> <span class="k">if</span> <span class="n">autover_section</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">sections</span><span class="p">()</span> <span class="k">else</span> <span class="n">pkgname</span>

    <span class="c1">###</span>
    <span class="c1"># hack archive_commit into section heading; see docstring</span>
    <span class="n">archive_commit</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">archive_commit_key</span> <span class="o">=</span> <span class="n">autover_section</span><span class="o">+</span><span class="s1">'.configparser_workaround.archive_commit'</span>
    <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">sections</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">section</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">archive_commit_key</span><span class="p">):</span>
            <span class="n">archive_commit</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">".*=\s*(\S*)\s*"</span><span class="p">,</span><span class="n">section</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1">###</span>
    <span class="k">return</span> <span class="n">get_setup_version</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span><span class="n">reponame</span><span class="o">=</span><span class="n">reponame</span><span class="p">,</span><span class="n">pkgname</span><span class="o">=</span><span class="n">pkgname</span><span class="p">,</span><span class="n">archive_commit</span><span class="o">=</span><span class="n">archive_commit</span><span class="p">)</span></div>


<span class="c1"># from param/version.py aa087db29976d9b7e0f59c29789dfd721c85afd0</span>
<div class="viewcode-block" id="OldDeprecatedVersion"><a class="viewcode-back" href="../../reference.html#param.version.OldDeprecatedVersion">[docs]</a><span class="k">class</span> <span class="nc">OldDeprecatedVersion</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    A simple approach to Python package versioning that supports PyPI</span>
<span class="sd">    releases and additional information when working with version</span>
<span class="sd">    control. When obtaining a package from PyPI, the version returned</span>
<span class="sd">    is a string-formatted rendering of the supplied release tuple.</span>
<span class="sd">    For instance, release (1,0) tagged as ``v1.0`` in the version</span>
<span class="sd">    control system will return ``1.0`` for ``str(__version__)``.  Any</span>
<span class="sd">    number of items can be supplied in the release tuple, with either</span>
<span class="sd">    two or three numeric versioning levels typical.</span>

<span class="sd">    During development, a command like ``git describe`` will be used to</span>
<span class="sd">    compute the number of commits since the last version tag, the</span>
<span class="sd">    short commit hash, and whether the commit is dirty (has changes</span>
<span class="sd">    not yet committed). Version tags must start with a lowercase 'v'</span>
<span class="sd">    and have a period in them, e.g. v2.0, v0.9.8 or v0.1.</span>

<span class="sd">    Development versions are supported by setting the dev argument to an</span>
<span class="sd">    appropriate dev version number. The corresponding tag can be PEP440</span>
<span class="sd">    compliant (using .devX) of the form v0.1.dev3, v1.9.0.dev2 etc but</span>
<span class="sd">    it doesn't have to be as the dot may be omitted i.e v0.1dev3,</span>
<span class="sd">    v1.9.0dev2 etc.</span>

<span class="sd">    Also note that when version control system (VCS) information is</span>
<span class="sd">    used, the comparison operators take into account the number of</span>
<span class="sd">    commits since the last version tag. This approach is often useful</span>
<span class="sd">    in practice to decide which version is newer for a single</span>
<span class="sd">    developer, but will not necessarily be reliable when comparing</span>
<span class="sd">    against a different fork or branch in a distributed VCS.</span>

<span class="sd">    For git, if you want version control information available even in</span>
<span class="sd">    an exported archive (e.g. a .zip file from GitHub), you can set</span>
<span class="sd">    the following line in the .gitattributes file of your project::</span>

<span class="sd">      __init__.py export-subst</span>
<span class="sd">    """</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">release</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fpath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">commit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">reponame</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dev</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">commit_count</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        :release:      Release tuple (corresponding to the current VCS tag)</span>
<span class="sd">        :commit        Short SHA. Set to '$Format:%h$' for git archive support.</span>
<span class="sd">        :fpath:        Set to ``__file__`` to access version control information</span>
<span class="sd">        :reponame:     Used to verify VCS repository name.</span>
<span class="sd">        :dev:          Development version number. None if not a development version.</span>
<span class="sd">        :commit_count  Commits since last release. Set for dev releases.</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fpath</span> <span class="o">=</span> <span class="n">fpath</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_expected_commit</span> <span class="o">=</span> <span class="n">commit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expected_release</span> <span class="o">=</span> <span class="n">release</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_commit</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">commit</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s2">"$Format:%h$"</span><span class="p">]</span> <span class="k">else</span> <span class="n">commit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_commit_count</span> <span class="o">=</span> <span class="n">commit_count</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_release</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reponame</span> <span class="o">=</span> <span class="n">reponame</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">release</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">"Return the release tuple"</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch</span><span class="p">()</span><span class="o">.</span><span class="n">_release</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">commit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">"A specification for this particular VCS version, e.g. a short git SHA"</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch</span><span class="p">()</span><span class="o">.</span><span class="n">_commit</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">commit_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">"Return the number of commits since the last release"</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch</span><span class="p">()</span><span class="o">.</span><span class="n">_commit_count</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dirty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">"True if there are uncommited changes, False otherwise"</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch</span><span class="p">()</span><span class="o">.</span><span class="n">_dirty</span>


<div class="viewcode-block" id="OldDeprecatedVersion.fetch"><a class="viewcode-back" href="../../reference.html#param.version.OldDeprecatedVersion.fetch">[docs]</a>    <span class="k">def</span> <span class="nf">fetch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Returns a tuple of the major version together with the</span>
<span class="sd">        appropriate SHA and dirty bit (for development version only).</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_release</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_release</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_release</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fpath</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_commit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expected_commit</span>
            <span class="k">return</span> <span class="bp">self</span>

         <span class="c1"># Only git right now but easily extended to SVN, Mercurial, etc.</span>
        <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'git'</span><span class="p">,</span> <span class="s1">'git.cmd'</span><span class="p">,</span> <span class="s1">'git.exe'</span><span class="p">]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">git_fetch</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">except</span> <span class="ne">EnvironmentError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">return</span> <span class="bp">self</span></div>


    <span class="k">def</span> <span class="nf">git_fetch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="o">=</span><span class="s1">'git'</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reponame</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Verify this is the correct repository (since fpath could</span>
                <span class="c1"># be an unrelated git repository, and param could just have</span>
                <span class="c1"># been copied/installed into it).</span>
                <span class="n">output</span> <span class="o">=</span> <span class="n">run_cmd</span><span class="p">([</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'remote'</span><span class="p">,</span> <span class="s1">'-v'</span><span class="p">],</span>
                                 <span class="n">cwd</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fpath</span><span class="p">))</span>
                <span class="n">repo_matches</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'/'</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">reponame</span> <span class="o">+</span> <span class="s1">'.git'</span> <span class="p">,</span>
                                <span class="c1"># A remote 'server:reponame.git' can also be referred</span>
                                <span class="c1"># to (i.e. cloned) as `server:reponame`.</span>
                                <span class="s1">'/'</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">reponame</span> <span class="o">+</span> <span class="s1">' '</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">m</span> <span class="ow">in</span> <span class="n">output</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">repo_matches</span><span class="p">):</span>
                    <span class="k">return</span> <span class="bp">self</span>

            <span class="n">output</span> <span class="o">=</span> <span class="n">run_cmd</span><span class="p">([</span><span class="n">cmd</span><span class="p">,</span> <span class="s1">'describe'</span><span class="p">,</span> <span class="s1">'--long'</span><span class="p">,</span> <span class="s1">'--match'</span><span class="p">,</span> <span class="s1">'v*.*'</span><span class="p">,</span> <span class="s1">'--dirty'</span><span class="p">],</span>
                             <span class="n">cwd</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fpath</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'fatal: No names found, cannot describe anything.'</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">"Cannot find any git version tags of format v*.*"</span><span class="p">)</span>
            <span class="c1"># If there is any other error, return (release value still useful)</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_update_from_vcs</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_from_vcs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">):</span>
        <span class="s2">"Update state based on the VCS state e.g the output of git describe"</span>
        <span class="n">split</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'-'</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">'dev'</span> <span class="ow">in</span> <span class="n">split</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">dev_split</span> <span class="o">=</span> <span class="n">split</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'dev'</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dev_split</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">split</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev_split</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># Remove the pep440 dot if present</span>
            <span class="k">if</span> <span class="n">split</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">'.'</span><span class="p">):</span>
                <span class="n">split</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev_split</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_release</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">el</span><span class="p">)</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">split</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'.'</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_commit_count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">split</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_commit</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">split</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span> <span class="c1"># Strip out 'g' prefix ('g'=&gt;'git')</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span> <span class="o">=</span> <span class="p">(</span><span class="n">split</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">'dirty'</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>


    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Version in x.y.z string format. Does not include the "v"</span>
<span class="sd">        prefix of the VCS version tags, for pip compatibility.</span>

<span class="sd">        If the commit count is non-zero or the repository is dirty,</span>
<span class="sd">        the string representation is equivalent to the output of::</span>

<span class="sd">          git describe --long --match v*.* --dirty</span>

<span class="sd">        (with "v" prefix removed).</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">release</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="s1">'None'</span>
        <span class="n">release</span> <span class="o">=</span> <span class="s1">'.'</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">el</span><span class="p">)</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="p">)</span>
        <span class="n">release</span> <span class="o">=</span> <span class="s1">'</span><span class="si">%s</span><span class="s1">.dev</span><span class="si">%d</span><span class="s1">'</span> <span class="o">%</span> <span class="p">(</span><span class="n">release</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dev</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dev</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">release</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_expected_commit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span>  <span class="p">(</span><span class="s2">"$Format"</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expected_commit</span><span class="p">):</span>
            <span class="k">pass</span>  <span class="c1"># Concrete commit supplied - print full version string</span>
        <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">commit_count</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dirty</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">release</span>

        <span class="n">dirty_status</span> <span class="o">=</span> <span class="s1">'-dirty'</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dirty</span> <span class="k">else</span> <span class="s1">''</span>
        <span class="k">return</span> <span class="s1">'</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">-g</span><span class="si">%s%s</span><span class="s1">'</span> <span class="o">%</span> <span class="p">(</span><span class="n">release</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">commit_count</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">commit_count</span> <span class="k">else</span> <span class="s1">'x'</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">commit</span><span class="p">,</span> <span class="n">dirty_status</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="OldDeprecatedVersion.abbrev"><a class="viewcode-back" href="../../reference.html#param.version.OldDeprecatedVersion.abbrev">[docs]</a>    <span class="k">def</span> <span class="nf">abbrev</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dev_suffix</span><span class="o">=</span><span class="s2">""</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Abbreviated string representation, optionally declaring whether it is</span>
<span class="sd">        a development version.</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="s1">'.'</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">el</span><span class="p">)</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="p">)</span> <span class="o">+</span> \
            <span class="p">(</span><span class="n">dev_suffix</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">commit_count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">dirty</span> <span class="k">else</span> <span class="s2">""</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Two versions are considered equivalent if and only if they are</span>
<span class="sd">        from the same release, with the same commit count, and are not</span>
<span class="sd">        dirty.  Any dirty version is considered different from any</span>
<span class="sd">        other version, since it could potentially have any arbitrary</span>
<span class="sd">        changes even for the same release and commit count.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dirty</span> <span class="ow">or</span> <span class="n">other</span><span class="o">.</span><span class="n">dirty</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">commit_count</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dev</span><span class="p">)</span>
                <span class="o">==</span> <span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">release</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">commit_count</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">dev</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__gt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">release</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">release</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dev</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">dev</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">commit_count</span> <span class="o">&gt;</span> <span class="n">other</span><span class="o">.</span><span class="n">commit_count</span>
            <span class="k">elif</span> <span class="kc">None</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dev</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">dev</span><span class="p">]:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dev</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dev</span> <span class="o">&gt;</span> <span class="n">other</span><span class="o">.</span><span class="n">dev</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">commit_count</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">release</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">commit_count</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">==</span><span class="n">other</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span> <span class="o">&gt;</span> <span class="n">other</span><span class="p">)</span>


<div class="viewcode-block" id="OldDeprecatedVersion.verify"><a class="viewcode-back" href="../../reference.html#param.version.OldDeprecatedVersion.verify">[docs]</a>    <span class="k">def</span> <span class="nf">verify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string_version</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Check that the version information is consistent with the VCS</span>
<span class="sd">        before doing a release. If supplied with a string version,</span>
<span class="sd">        this is also checked against the current version. Should be</span>
<span class="sd">        called from setup.py with the declared package version before</span>
<span class="sd">        releasing to PyPI.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="n">string_version</span> <span class="ow">and</span> <span class="n">string_version</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">"Supplied string version does not match current version."</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dirty</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">"Current working directory is dirty."</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">release</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_release</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">"Declared release does not match current release tag."</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">commit_count</span> <span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">"Please update the VCS version tag before release."</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expected_commit</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s2">"$Format:%h$"</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">"Declared release does not match the VCS version tag"</span><span class="p">)</span></div></div>
</pre></div>
</div>
<div class="prev-next-bottom">
</div>
</main>
</div>
</div>
<script src="../../_static/js/index.1c5a1a01449ed65a7b51.js"></script>
<script async="" src="https://www.google-analytics.com/analytics.js"></script>
<script>
                        window.ga = window.ga || function () {
                            (ga.q = ga.q || []).push(arguments) };
                        ga.l = +new Date;
                        ga('create', 'UA-154795830-6', 'auto');
                        ga('set', 'anonymizeIp', true);
                        ga('send', 'pageview');
                    </script>
<footer class="footer mt-5 mt-md-0">
<div class="container">
<div class="footer-item">
<p class="copyright">
    Â© Copyright 2003-2021 HoloViz developers.<br/>
</p>
</div>
<div class="footer-item">
<p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 3.5.4.<br/>
</p>
</div>
</div>
</footer>
</body>
</html>